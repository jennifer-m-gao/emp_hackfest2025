<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seattle Map – draggable, colored areas, clickable icons</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="..\styles.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-popup-content-wrapper { background: #1e293b; color: #f1f5f9; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    .leaflet-popup-tip { background: #1e293b; }
    .leaflet-popup-content { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .popup-content p { margin: 4px 0; }
    .status.stable { color: #22c55e; font-weight: bold; }
    .status.serious { color: #eab308; font-weight: bold; }
    .status.critical { color: #ef4444; font-weight: bold; }
  </style>
</head>

<body>
  <div class="layout">
    <div class="sidebar-left">
      <div class="sidebar-logo">
        <img src="..\logo.png" alt="Logo">
      </div>
      <ul>
        <li><a href="../paramedicsDashboard.html">Dashboard</a></li>
        <li><a href="../Checklist\checklist.html">Pre-Disaster Checklist</a></li>
        <li><a href="../userDashboard.html">Profile</a></li>
        <li><a href="../I-need-help\index.html" class="help-btn">Get Help</a></li>
      </ul>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map', {
      zoomControl: true,
      dragging: true,
    }).setView([47.6062, -122.3321], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const areas = [{ name: 'earthquake', color: '#ef4444', coords: [[47.863252,-123.254382],[47.863252,-121.875549],[47.010633,-121.875549],[47.010633,-123.254382]] }];
    areas.forEach(a => L.polygon(a.coords, { color: a.color, weight: 2, fillColor: a.color, fillOpacity: 0.25 }).addTo(map));

    // -------- Icons & Statuses --------
    const greenIcon = new L.icon({ iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const yellowIcon = new L.icon({ iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png', shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const redIcon = new L.icon({ iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

    const statuses = [
      { name: "stable", minHR: 60, maxHR: 100, icon: greenIcon },
      { name: "serious", minHR: 40, maxHR: 60, icon: yellowIcon },
      { name: "critical", minHR: 0, maxHR: 40, icon: redIcon }
    ];

    function pickStatus() {
      const n = Math.floor(Math.random()*10)+1;
      return n<=7 ? statuses[0] : (n<=9 ? statuses[1] : statuses[2]);
    }

    // -------- Person & Update Logic --------
    function Person(age, gender, X, Y, amenities, people) {
      this.age = age; this.gender = gender; this.X = X; this.Y = Y;
      this.status = pickStatus();
      this.heartRate = Math.random()*(this.status.maxHR-this.status.minHR)+this.status.minHR;
      this.bodyTemp = Math.random()*(97-95)+95;
      this.amenities = amenities;
      this.people = people;
    }

    function updatePerson(person){
      let change = person.status.name==="stable"?Math.random()*1:person.status.name==="serious"?Math.random()*2:Math.random()*4;
      person.heartRate += Math.random()>0.5 ? change : -change;
      person.heartRate = Math.min(Math.max(person.heartRate,20),200);
      person.status = person.heartRate>60?statuses[0]:person.heartRate>40?statuses[1]:statuses[2];

      let tempChange = person.status.name==="stable"?2:person.status.name==="serious"?3:4;
      person.bodyTemp += Math.random()>0.5?tempChange:-tempChange;
      if(person.bodyTemp<95) person.status=statuses[2];
      else if(person.bodyTemp<97) person.status=statuses[1];
      else person.status=statuses[0];
      person.bodyTemp = Math.min(Math.max(person.bodyTemp,80),110);
    }

    function getPopupContent(person){
      return `
        <div class="popup-content">
          <p><strong>Age:</strong> ${person.age}</p>
          <p><strong>Gender:</strong> ${person.gender}</p>
          <p><strong>Heart rate:</strong> ${Math.round(person.heartRate)} bpm</p>
          <p><strong>Body Temperature:</strong> ${Math.round(person.bodyTemp)} °F</p>
          <p class="status ${person.status.name}"><strong>Status:</strong> ${person.status.name}</p>
          <p><strong>Amenities:</strong> ${person.amenities}</p>
          <p><strong>People:</strong> ${person.people}</p>
        </div>
      `;
    }

    const people = [];
    const markers = [];

    people.push(new Person(32,"female",47.6097,-122.3331,"food, water, communication",2));
    people.push(new Person(45,"male",47.6205,-122.3493,"first aid",7));

    const submissions = JSON.parse(localStorage.getItem('submissions')) || [];
    function simulateSubmission(sub){
      const lat = 47.60 + (Math.random()-0.5)*0.1;
      const long = -122.33 + (Math.random()-0.5)*0.1;
      const gender = Math.random()>0.5?"male":"female";
      const p = new Person(
        Math.floor(Math.random()*61)+10,
        gender,
        lat,long,
        sub.amenities?sub.amenities.join(","):'',
        parseInt(sub['num-people'])||1
      );
      const danger = parseInt(sub['danger-level']);
      if(danger<=2) p.status=statuses[0];
      else if(danger==3) p.status=statuses[1];
      else p.status=statuses[2];
      if(sub['injury']=='yes'){p.heartRate*=0.9;p.bodyTemp-=1;}
      return p;
    }

    submissions.forEach(sub => {
      const p = simulateSubmission(sub);
      people.push(p);
    });

    people.forEach(person=>{
      const marker = L.marker([person.X, person.Y], { icon: person.status.icon }).addTo(map);
      marker.bindPopup(getPopupContent(person));
      markers.push(marker);
    });

    setInterval(()=>{
      const stored = JSON.parse(localStorage.getItem('submissions')) || [];
      stored.forEach(sub=>{
        if(!sub._added){
          const p = simulateSubmission(sub);
          people.push(p);
          const m = L.marker([p.X,p.Y],{icon:p.status.icon}).addTo(map);
          m.bindPopup(getPopupContent(p));
          markers.push(m);
          sub._added = true;
        }
      });
      localStorage.setItem('submissions',JSON.stringify(stored));

      people.forEach((p,i)=>{
        updatePerson(p);
        markers[i].setIcon(p.status.icon);
        const popup = markers[i].getPopup();
        popup.setContent(getPopupContent(p));
        if(popup.isOpen()) popup.update();
      });
    }, 1500);


    function onMapClick(e) {
      L.popup()
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(map);
    }

    map.on('click', onMapClick);
  </script>
</body>
</html>
