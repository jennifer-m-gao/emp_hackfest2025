<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seattle Map â€“ draggable, colored areas, clickable icons</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="..\styles.css">

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    #map {
      height: 100%;
      width: 60%;
      flex: 1;
    }

    .leaflet-popup-content {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .pin {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #1d4ed8;
      display: grid;
      place-items: center;
      color: white;
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .4);
      transform: translate(-11px, -11px);
    }

    .pin::after {
      content: "";
      position: absolute;
      width: 0;
      height: 0;
      left: 9px;
      top: 18px;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 8px solid #1d4ed8;
    }
  </style>
</head>

<body>
  <div class="layout">

    <div class="sidebar-left">
      <div class="sidebar-logo">
        <img src="..\logo.png" alt="Logo">
      </div>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="checklist.html">Pre-Disaster Checklist</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="help.html" class="help-btn">I Need Help</a></li>
      </ul>
    </div>

    <div id="map"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      const map = L.map('map', {
        minZoom: 10,
        maxZoom: 16,
        zoomControl: true,
        dragging: true,
      }).setView([47.6062, -122.3321], 9);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      const areas = [
        {
          name: 'EARTHQUAKE ZONE',
          color: '#ef4444',
          coords: [
            [47.863252, -123.254382],
            [47.863252, -121.875549],
            [47.010633, -121.875549],
            [47.010633, -123.254382]
          ]
        },
      ];
      const currentLocation = L.latLng(47.688777, -122.150111);

      /* Pulling & Plotting Infrastructure Point Coordinates */
      const fireStations = [];
      fetch("data/Fire_Station_Locations_in_King_County___firestn_point.csv")
        .then(response => response.text())
        .then(text => {
          const rows = text.trim().split("\n").map(r => r.split(","));
          const dataRows = rows.slice(1);

          const fireStations = dataRows.map(row => [row[0], row[1], row[6]]);

          proj4.defs("EPSG:2285",
            "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
            "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
            "+datum=NAD83 +units=us-ft +no_defs +type=crs"
          );

          fireStations.forEach(station => {
            const x = parseFloat(station[0]);
            const y = parseFloat(station[1]);
            const name = station[2];

            const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

            console.log("Converted:", name, lat, lng);

            const fireIcon = L.icon({
              iconUrl: 'media/icon-fire-station.png',
              iconSize: [25, 25],
              iconAnchor: [11, 22],
              popupAnchor: [0, -18],
            });

            const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
            const distanceMiles = (distanceMeters / 1609.34).toFixed(2);


            if (!isNaN(lat) && !isNaN(lng)) {
              L.marker([lat, lng], { icon: fireIcon })
                .addTo(map)
                .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
            }
          });
        });


      const policeStations = [];
      fetch("data/Police_Station_Locations_in_King_County___kcp_loc_point.csv")
        .then(response => response.text())
        .then(text => {
          const rows = text.trim().split("\n").map(r => r.split(","));
          const dataRows = rows.slice(1);

          dataRows.forEach(row => {
            policeStations.push([row[0], row[1], row[6]]);
          });

          console.log(policeStations);
          proj4.defs("EPSG:2285",
            "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
            "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
            "+datum=NAD83 +units=us-ft +no_defs +type=crs"
          );

          policeStations.forEach(station => {
            const x = parseFloat(station[0]);
            const y = parseFloat(station[1]);
            const name = station[2];

            const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

            console.log("Converted:", name, lat, lng);

            const policeIcon = L.icon({
              iconUrl: 'media/icon-police-station2.png',
              iconSize: [25, 25],
              iconAnchor: [11, 22],
              popupAnchor: [0, -18],
            });

            const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
            const distanceMiles = (distanceMeters / 1609.34).toFixed(2);


            if (!isNaN(lat) && !isNaN(lng)) {
              L.marker([lat, lng], { icon: policeIcon })
                .addTo(map)
                .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
            }
          });
        });

      const hospitals = [];
      fetch("data/Medical_Facilities_including_Hospitals___medical_facilities_point.csv")
        .then(response => response.text())
        .then(text => {
          const rows = text.trim().split("\n").map(r => r.split(","));
          const dataRows = rows.slice(1);

          dataRows.forEach(row => {
            hospitals.push([row[0], row[1], row[6]]);
          });

          console.log(hospitals);

          proj4.defs("EPSG:2285",
            "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
            "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
            "+datum=NAD83 +units=us-ft +no_defs +type=crs"
          );

          hospitals.forEach(station => {
            const x = parseFloat(station[0]);
            const y = parseFloat(station[1]);
            const name = station[2];

            const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

            console.log("Converted:", name, lat, lng);

            const hospitalIcon = L.icon({
              iconUrl: 'media/icon-hospital-nobg.png',
              iconSize: [23, 23],
              iconAnchor: [11, 22],
              popupAnchor: [0, -18],
            });

            const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
            const distanceMiles = (distanceMeters / 1609.34).toFixed(2);


            if (!isNaN(lat) && !isNaN(lng)) {
              L.marker([lat, lng], { icon: hospitalIcon })
                .addTo(map)
                .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
            }
          });
        });



      areas.forEach(a => {
        const poly = L.polygon(a.coords, {
          color: a.color,
          weight: 2,
          fillColor: a.color,
          fillOpacity: 0.25
        }).addTo(map);

        poly.bindPopup(`<strong>${a.name}</strong>`);

      });

      const imageIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      L.marker([47.688777, -122.150111], { icon: imageIcon })
        .addTo(map)
        .bindPopup('<b>Current Location</b><br/>');

      proj4.defs("EPSG:2285", "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 +lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 +datum=NAD83 +units=us-ft +no_defs +type=crs");
    </script>
</body>

</html>