<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    /* General Styling */
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: 'Inter', sans-serif;
    }

    /* Sidebar Styling & Layout */
    .layout {
      display: flex;
      height: 100vh;
    }
    .sidebar-left {
        width: 250px;
        background-color: #b62222;
        color: #ffffff;
        min-height: calc(100vh - 0px); 
        display: flex;
        flex-direction: column;
        padding-top: 1rem;
    }

    .sidebar-logo {
        text-align: center;
    }
    .sidebar-logo img {
        max-width: 150px;
        height: auto;
    }

    .sidebar-left ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .sidebar-left a {
        text-decoration: none;
        color: #ffffff;
        font-weight: bold;
        padding: 0.75rem 1.25rem;
        display: block;
        transition: background-color 0.25s ease;
    }

    .sidebar-left a:hover {
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 4px;
    }

    .sidebar-left .help-btn {
        background-color: #ffffff;
        color: #b62222 !important;
        text-align: left;
        border-radius: 4px;
    }

    .sidebar-left .help-btn:hover {
        background-color: #e2d9bb;
    }

    #map {
      flex: 1; 
      height: 100vh;
      width: 100%;
    }

    /* Map Popup Styling */
    .leaflet-popup-content-wrapper {
      background: #1e293b;  
      color: #f1f5f9;       
      border-radius: 12px;  
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .leaflet-popup-tip {
      background: #1e293b;   
    }

    .leaflet-popup-content { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    .popup-content {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .popup-content p {
      margin: 4px 0;
    }

    /* Alert Popup Styling */
    .alert {
        position:fixed;
        border-color: rgb(201, 38, 38);
        color: rgb(201, 38, 38);
        border-width: 3px;
        width: 40vw;
        height: fit-content;
        margin-top: 1.5vh;
        font-size: 125%;
        left: 35%;
        z-index: 1000;
    }

    .x-button {
      position:fixed;
      margin-top: 2.0vh;
      color: rgb(201, 38, 38);
      border:none;
      left: 35.5%;
      z-index:9999;
    }

    /* Logout Button Styling */
    .back-button {
        background-color: var(--white);
        width: 100%;
        display: flex;
        justify-content: flex-start;
    }

    .back-button button {
        margin-top: 40vh;
        margin-left: 3.65vw;
        padding: 0.65rem 1.45rem;
        background-color: var(--white);
        color: var(--dark-green);
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 1.15rem;
        transition: background-color 0.25s ease, transform 0.2s ease;
        border: 2px solid white;
    }

    .back-button button:hover {
        background-color: #f1e9c8;
        transform: translateY(-2px);
    }
  </style>
</head>

<body>
  <!--Alert Popup-->
  <button class="alert" id="alert-button">ALERT! 5.0 magnitude earthquake reported in your region!</button>
  <button style="cursor:pointer;" class="x-button" id="x" onclick="removeAlert()"><b>x</b></button>

  <!-- Main Layout with Sidebar and Map -->
  <div class="layout">
    <!--Sidebar-->
    <div class="sidebar-left">
      <div class="sidebar-logo">
        <img src="media/logo.png" alt="Logo">
      </div>
      <ul>
        <li><a href="userDashboard.html">Dashboard</a></li>
        <li><a href="Checklist/checklistform.html">Pre-Disaster Checklist</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="../I-need-help/index.html" class="help-btn">Get Help</a></li>
        <div class="back-button">
            <button type="button" onclick="window.location.href='index.html'">
                ‚Üê Logout
            </button>
        </div>
      </ul>
    </div>
    <!--Map-->
    <div id="map"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    /* Initializing Map */
    const yourName = localStorage.getItem('firstName') || 'User';
    const map = L.map('map', {
      minZoom: 10,
      maxZoom: 16,
      zoomControl: true,
      dragging: true,
    }).setView([47.7062, -122.1321], 11.3);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const areas = [
      {
        name: 'EARTHQUAKE ZONE',
        color: '#ef4444',
        coords: [
          [47.863252, -122.474382],
          [47.863252, -121.875549],
          [47.010633, -121.875549],
          [47.010633, -122.474382]
        ]
      },
    ];
    const currentLocation = L.latLng(47.688777, -122.150111);

    /* Pulling & Plotting Infrastructure Point Coordinates */
    const fireStations = [];
    fetch("data/Fire_Station_Locations_in_King_County___firestn_point.csv")
      .then(response => response.text())
      .then(text => {
        const rows = text.trim().split("\n").map(r => r.split(","));
        const dataRows = rows.slice(1);

        const fireStations = dataRows.map(row => [row[0], row[1], row[6]]);

        proj4.defs("EPSG:2285",
          "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
          "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
          "+datum=NAD83 +units=us-ft +no_defs +type=crs"
        );

        fireStations.forEach(station => {
          const x = parseFloat(station[0]);
          const y = parseFloat(station[1]);
          const name = station[2];

          const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

          console.log("Converted:", name, lat, lng);

          const fireIcon = L.icon({
            iconUrl: 'media/icon-fire-station.png',
            iconSize: [25, 25],
            iconAnchor: [11, 22],
            popupAnchor: [0, -18],
          });

          const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
          const distanceMiles = (distanceMeters / 1609.34).toFixed(2);


          if (!isNaN(lat) && !isNaN(lng)) {
            L.marker([lat, lng], { icon: fireIcon })
              .addTo(map)
              .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
          }
        });
      });


    const policeStations = [];
    fetch("data/Police_Station_Locations_in_King_County___kcp_loc_point.csv")
      .then(response => response.text())
      .then(text => {
        const rows = text.trim().split("\n").map(r => r.split(","));
        const dataRows = rows.slice(1);

        dataRows.forEach(row => {
          policeStations.push([row[0], row[1], row[6]]);
        });

        console.log(policeStations);
        proj4.defs("EPSG:2285",
          "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
          "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
          "+datum=NAD83 +units=us-ft +no_defs +type=crs"
        );

        policeStations.forEach(station => {
          const x = parseFloat(station[0]);
          const y = parseFloat(station[1]);
          const name = station[2];

          const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

          console.log("Converted:", name, lat, lng);

          const policeIcon = L.icon({
            iconUrl: 'media/icon-police-station2.png',
            iconSize: [25, 25],
            iconAnchor: [11, 22],
            popupAnchor: [0, -18],
          });

          const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
          const distanceMiles = (distanceMeters / 1609.34).toFixed(2);


          if (!isNaN(lat) && !isNaN(lng)) {
            L.marker([lat, lng], { icon: policeIcon })
              .addTo(map)
              .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
          }
        });
      });

    const hospitals = [];
    fetch("data/Medical_Facilities_including_Hospitals___medical_facilities_point.csv")
      .then(response => response.text())
      .then(text => {
        const rows = text.trim().split("\n").map(r => r.split(","));
        const dataRows = rows.slice(1);

        dataRows.forEach(row => {
          hospitals.push([row[0], row[1], row[6]]);
        });

        console.log(hospitals);

        proj4.defs("EPSG:2285",
          "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 " +
          "+lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 " +
          "+datum=NAD83 +units=us-ft +no_defs +type=crs"
        );

        hospitals.forEach(station => {
          const x = parseFloat(station[0]);
          const y = parseFloat(station[1]);
          const name = station[2];

          const [lng, lat] = proj4("EPSG:2285", "EPSG:4326", [x, y]);

          console.log("Converted:", name, lat, lng);

          const hospitalIcon = L.icon({
            iconUrl: 'media/icon-hospital-nobg.png',
            iconSize: [23, 23],
            iconAnchor: [11, 22],
            popupAnchor: [0, -18],
          });

          const distanceMeters = currentLocation.distanceTo(L.latLng(lat, lng));
          const distanceMiles = (distanceMeters / 1609.34).toFixed(2);

          if (!isNaN(lat) && !isNaN(lng)) {
            L.marker([lat, lng], { icon: hospitalIcon })
              .addTo(map)
              .bindPopup(`<b>${name}</b><br/>Distance from current location: ${distanceMiles} miles`);
          }
        });
      });


    /* Plotting Danger Zones */
    areas.forEach(a => {
      const poly = L.polygon(a.coords, {
        color: a.color,
        weight: 2,
        fillColor: a.color,
        fillOpacity: 0.25
      }).addTo(map);

      poly.bindPopup(`<strong>${a.name}</strong>`);

    });

    const imageIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    /* Pulling & Plotting User Info from Local Storage */
    const submissions = JSON.parse(localStorage.getItem('submissions')) || [];
    let amenities = 'None';
    let numPeople = 0;
    submissions.forEach(sub => {
      amenities = (sub.amenities && sub.amenities.length > 0) 
        ? sub.amenities.join(", ") 
        : 'None';
      numPeople = parseInt(sub['num-people']);
    });

    const age = localStorage.getItem('age');
    const gender = localStorage.getItem('gender');
    L.marker([47.688777, -122.150111], { icon: imageIcon })
      .addTo(map)
      .bindPopup(`<div class="popup-content">
          <p><strong>Name:</strong> ${yourName}</p>
          <p><strong>Age:</strong> ${age}</p>
          <p><strong>Gender:</strong> ${gender}</p>
          <p><strong>Needs:</strong> ${amenities}</p>
          <p><strong>People With Them:</strong> ${numPeople}</p>
        </div>`);

    proj4.defs("EPSG:2285", "+proj=lcc +lat_1=48.73333333333333 +lat_2=47.5 +lat_0=47 +lon_0=-120.8333333333333 +x_0=500000.0000000001 +y_0=0 +datum=NAD83 +units=us-ft +no_defs +type=crs");
    
    /* Alert Popup Dismissal */
    function removeAlert() {
      document.getElementById("alert-button").style.display = 'none';
      document.getElementById("x").style.display = 'none';
    }
  </script>
</body>
</html>